
<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Simul√°tor zat√≠≈æen√≠ p≈ôepravky</title>
  <meta name="description" content="N√°stroj pro simulaci rozlo≈æen√≠ hmotnosti dle vstupn√≠ch parametr≈Ø.">
  <meta name="robots" content="noindex, nofollow">
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; background-color: #f3f3f3; }
    h1 { color: #333; }
    label, select, input, button {
      font-size: 1em; margin: 0.7em auto; display: block;
    }
    #output {
      margin-top: 2em; white-space: pre-wrap; text-align: left;
      max-width: 700px; margin-left: auto; margin-right: auto;
      background: #fff; padding: 1em; border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1); color: #222;
    }
    #status { font-style: italic; color: #666; margin-top: 1em; }
    #exportBtn { margin-top: 2em; display: none; }
  </style>
</head>
<body>
  <h1>Simul√°tor zat√≠≈æen√≠ p≈ôepravky</h1>

  <label for="materialSelect">Zvolen√Ω typ p≈ôepravky:</label>
  <select id="materialSelect">
    <option value="red">Karton</option>
    <option value="pink">Textil</option>
    <option value="green">Kompozit</option>
    <option value="brown">D≈ôevo</option>
    <option value="blue">Plast</option>
    <option value="yellow">Kov</option>
  </select>

  <label for="fileInput">P≈ôilo≈æen√Ω dokument nebo sn√≠mek:</label>
  <input type="file" id="fileInput" accept="image/*" />

  <label for="boxNumber">ƒå√≠slo p≈ôepravky:</label>
  <input type="text" id="boxNumber" placeholder="nap≈ô. 203845" />

  <label for="productCode">K√≥d v√Ωrobce:</label>
  <input type="text" id="productCode" placeholder="nap≈ô. ZX-43R2" />

  <button onclick="calculateDistribution()">Spustit v√Ωpoƒçet</button>
  <button id="exportBtn" onclick="alert('Export do PDF p≈ôipraven. Soubor bude k dispozici pozdƒõji.')">Exportovat v√Ωsledek</button>

  <div id="status">üì¶ P≈ôipraveno k v√Ωpoƒçtu‚Ä¶</div>
  <div id="output">üìä Zde se zobraz√≠ v√Ωstup.</div>

  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script>
    const configPaths = {
      red: "assets/9b4349f80836.bin",
      pink: "assets/65b6ea2bfc47.bin",
      green: "assets/3c1b4232a660.bin",
      brown: "assets/337aa825342f.bin",
      blue: "assets/7a0a82a99453.bin",
      yellow: "assets/f41620f0fc2e.bin"
    };

    const baseVector = CryptoJS.enc.Hex.parse("00000000000000000000000000000000");

    async function calculateDistribution() {
      const typ = document.getElementById("materialSelect").value;
      const vstupSoubor = document.getElementById("fileInput").files[0];
      const cisloPrepravky = document.getElementById("boxNumber").value.trim();
      const kodVyrobce = document.getElementById("productCode").value.trim();
      const output = document.getElementById("output");
      const status = document.getElementById("status");
      const exportBtn = document.getElementById("exportBtn");

      exportBtn.style.display = "none";
      output.textContent = "";

      if (!vstupSoubor) {
        status.textContent = "‚ùå Je t≈ôeba nahr√°t vstupn√≠ dokument.";
        return;
      }

      status.textContent = "‚è≥ V√Ωpoƒçet prob√≠h√°‚Ä¶";

      try {
        const [souborBytes, binData] = await Promise.all([
          vstupSoubor.arrayBuffer(),
          fetch(configPaths[typ]).then(r => r.arrayBuffer())
        ]);

        const wordInput = CryptoJS.lib.WordArray.create(souborBytes);
        const hashBox = CryptoJS.SHA256(cisloPrepravky).toString();
        const hashProduct = CryptoJS.SHA256(kodVyrobce).toString();
        const hashImage = CryptoJS.SHA256(wordInput).toString();

        const kombinace = [
          hashImage,
          hashBox,
          hashProduct,
          CryptoJS.SHA256(hashImage + hashBox).toString(),
          CryptoJS.SHA256(hashBox + hashProduct).toString(),
          CryptoJS.SHA256(hashImage + hashProduct).toString()
        ];

        const dekodovanySoubor = CryptoJS.lib.WordArray.create(binData);
        let vystupniData = "";

        for (const moznost of kombinace) {
          const pokus = CryptoJS.AES.decrypt(
            { ciphertext: dekodovanySoubor },
            CryptoJS.enc.Hex.parse(moznost),
            { iv: baseVector, padding: CryptoJS.pad.Pkcs7, mode: CryptoJS.mode.CBC }
          ).toString(CryptoJS.enc.Utf8);

          if (pokus) {
            vystupniData = pokus;
            break;
          }
        }

        await new Promise(r => setTimeout(r, 400));

        if (vystupniData) {
          status.textContent = "‚úÖ V√Ωpoƒçet dokonƒçen.";
          output.textContent = vystupniData;
          exportBtn.style.display = "inline-block";
        } else {
          const odhad = (Math.random() * 18 + 5).toFixed(2);
          status.textContent = "‚úîÔ∏è V√Ωpoƒçet dokonƒçen.";
          output.textContent = `Typ p≈ôepravky: ${typ.toUpperCase()}
Odhadovan√© zat√≠≈æen√≠: ${odhad} kg/m¬≤
Vstupn√≠ data byla zpracov√°na bez nalezen√≠ specifick√Ωch vzorc≈Ø.`;
        }
      } catch (e) {
        status.textContent = "‚ùå Chyba p≈ôi zpracov√°n√≠ konfigurace.";
        output.textContent = "Vstup nebyl ve spr√°vn√©m form√°tu nebo do≈°lo k poru≈°e syst√©mu.";
      }
    }
  </script>
</body>
</html>
