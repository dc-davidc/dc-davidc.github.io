
<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Simulátor zatížení přepravky</title>
  <meta name="description" content="Nástroj pro simulaci rozložení hmotnosti dle vstupních parametrů.">
  <meta name="robots" content="noindex, nofollow">
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; background-color: #f3f3f3; }
    h1 { color: #333; }
    label, select, input, button {
      font-size: 1em; margin: 0.7em auto; display: block;
    }
    #output {
      margin-top: 2em; white-space: pre-wrap; text-align: left;
      max-width: 700px; margin-left: auto; margin-right: auto;
      background: #fff; padding: 1em; border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1); color: #222;
    }
    #status { font-style: italic; color: #666; margin-top: 1em; }
    #exportBtn { margin-top: 2em; display: none; }
  </style>
</head>
<body>
  <h1>Simulátor zatížení přepravky</h1>

  <label for="materialSelect">Zvolený typ přepravky:</label>
  <select id="materialSelect">
    <option value="red">Karton</option>
    <option value="pink">Textil</option>
    <option value="green">Kompozit</option>
    <option value="brown">Dřevo</option>
    <option value="blue">Plast</option>
    <option value="yellow">Kov</option>
  </select>

  <label for="fileInput">Přiložený dokument nebo snímek:</label>
  <input type="file" id="fileInput" accept="image/*" />

  <label for="boxNumber">Číslo přepravky:</label>
  <input type="text" id="boxNumber" placeholder="např. 203845" />

  <label for="productCode">Kód výrobce:</label>
  <input type="text" id="productCode" placeholder="např. ZX-43R2" />

  <button onclick="calculateDistribution()">Spustit výpočet</button>
  <button id="exportBtn" onclick="alert('Export do PDF připraven. Soubor bude k dispozici později.')">Exportovat výsledek</button>

  <div id="status">📦 Připraveno k výpočtu…</div>
  <div id="output">📊 Zde se zobrazí výstup.</div>

  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script>
    const configPaths = {
      red: "assets/9b4349f80836.bin",
      pink: "assets/65b6ea2bfc47.bin",
      green: "assets/3c1b4232a660.bin",
      brown: "assets/337aa825342f.bin",
      blue: "assets/7a0a82a99453.bin",
      yellow: "assets/f41620f0fc2e.bin"
    };

    const baseVector = CryptoJS.enc.Hex.parse("00000000000000000000000000000000");

    async function calculateDistribution() {
      const typ = document.getElementById("materialSelect").value;
      const vstupSoubor = document.getElementById("fileInput").files[0];
      const cisloPrepravky = document.getElementById("boxNumber").value.trim();
      const kodVyrobce = document.getElementById("productCode").value.trim();
      const output = document.getElementById("output");
      const status = document.getElementById("status");
      const exportBtn = document.getElementById("exportBtn");

      exportBtn.style.display = "none";
      output.textContent = "";

      if (!vstupSoubor) {
        status.textContent = "❌ Je třeba nahrát vstupní dokument.";
        return;
      }

      status.textContent = "⏳ Výpočet probíhá…";

      try {
        const [souborBytes, binData] = await Promise.all([
          vstupSoubor.arrayBuffer(),
          fetch(configPaths[typ]).then(r => r.arrayBuffer())
        ]);

        const wordInput = CryptoJS.lib.WordArray.create(souborBytes);

        // Kombinovaný klíč pouze pokud existují i další vstupy
        const komponenty = [CryptoJS.SHA256(wordInput).toString()];
        if (cisloPrepravky) komponenty.push(CryptoJS.SHA256(cisloPrepravky).toString());
        if (kodVyrobce) komponenty.push(CryptoJS.SHA256(kodVyrobce).toString());

        const combinedKey = CryptoJS.SHA256(
          CryptoJS.enc.Utf8.parse(komponenty.join(""))
        ).toString();

        const dekodovanySoubor = CryptoJS.lib.WordArray.create(binData);
        const pokus = CryptoJS.AES.decrypt(
          { ciphertext: dekodovanySoubor },
          CryptoJS.enc.Hex.parse(combinedKey),
          { iv: baseVector, padding: CryptoJS.pad.Pkcs7, mode: CryptoJS.mode.CBC }
        ).toString(CryptoJS.enc.Utf8);

        await new Promise(r => setTimeout(r, 400));

        if (pokus) {
          status.textContent = "✅ Výpočet dokončen.";
          output.textContent = pokus;
          exportBtn.style.display = "inline-block";
        } else {
          const odhad = (Math.random() * 18 + 5).toFixed(2);
          status.textContent = "✔️ Výpočet dokončen.";
          output.textContent = `Typ přepravky: ${typ.toUpperCase()}
Odhadované zatížení: ${odhad} kg/m²
Vstupní data byla zpracována bez nalezení specifických vzorců.`;
        }
      } catch (e) {
        status.textContent = "❌ Chyba při výpočtu.";
        output.textContent = "Nepodařilo se zpracovat konfiguraci. Zkuste jiný vstup.";
      }
    }
  </script>
</body>
</html>
s